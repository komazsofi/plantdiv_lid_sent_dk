# The script aims to derive basic information regarding the las/laz files with lasinfo from LAStools. 
#
# To use the script the inputdirectory, outputdirectory, lasinfoloc, lastype and dirname needs to be rightly set (see # Set working directories section). 
#
# To run the script from command line (Command Prompt) on a windows machine the following command can be used (after navigating the location of the Rscript file ((for me C:\Program Files\R\R-4.1.1\bin)): 
# C:\Program Files\R\R-4.1.1\bin>Rscript O:\Nat_Ecoinformatics-tmp\extractmeta_server.R
# O:\Nat_Ecoinformatics-tmp\ - needs to be set to the path of where the R file located

library(sf)
library(foreach)
library(doSNOW)
library(tcltk)
library(lidR)
library(dplyr)
library(cowplot)

# Set working directories
inputdirectory="O:/Nat_Ecoinformatics-tmp/au700510/lidar_process/metainfo_extract/test_diff_lasfiles/test2014_2/" #set this to the path where the laz (unzipped) files are located 
outputdirectory="O:/Nat_Ecoinformatics-tmp/au700510/lidar_process/metainfo_extract/test_diff_lasfiles/" #set this to the path where the resulted files wished to be extracted
lasinfoloc="C:/_Koma/LAStools/LAStools/bin/" #set this to the path where the lasinfo.exe file is located 
lastype="laz" #set this either laz or las depending on how the lidar data is stored
dirname="test2014_2" #set this based on the input directory name to name the file based on the directory origin

start_time <- Sys.time()

# Writing out metainfo into a shp file

setwd(lasinfoloc)

filelist=list.files(path=inputdirectory, pattern=paste("\\.",lastype,"$",sep=""), full.name=TRUE, include.dirs=TRUE, recursive=TRUE)

lasinfo <- data.frame(matrix(ncol = 27, nrow = 0))
x <- c("BlockID","FileName", "wkt_astext","NumPoints","MinGpstime", "MaxGpstime","Year","Month","Day","zmin","zmax","maxRetNum","maxNumofRet","minClass","maxClass",
       "minScanAngle","maxScanAngle","FirstRet","InterRet","LastRet","SingleRet","allPointDens","lastonlyPointDens","minFileID","maxFileID","epgs","crs")
colnames(lasinfo) <- x

## set up parameters for the parallel process

Nclust <- parallel::detectCores()-2

cl <-makeCluster(Nclust,outfile=paste(outputdirectory,dirname,"_log.txt",sep=""))
registerDoSNOW(cl)

ntasks <- length(filelist)
pb <- tkProgressBar(max=ntasks)
progress <- function(n) setTkProgressBar(pb, n)
opts <- list(progress=progress)

lasinfo <- foreach(i=1:length(filelist), .combine = rbind, .packages = c("sf","lidR","dplyr"), .options.snow=opts, .errorhandling = "remove") %dopar% {
  
  print(filelist[i])
  
  lidrmeta=readLASheader(filelist[i])
  
  tmp <- system(paste("lasinfo.exe ",filelist[i]," -stdout -compute_density",sep=""), intern=TRUE, wait=FALSE)
  
  FileName <- paste(filelist[i])
  
  BlockID <- substring(FileName,nchar(FileName)-11,nchar(FileName)-4) 
  
  NumPoints_str <- tmp[(grep(pattern = "  number of point records", tmp))]
  NumPoints<-as.numeric(unlist(strsplit(NumPoints_str, split=" "))[10])
  
  mins=tmp[(grep(pattern='min x y z', tmp))]
  maxs=tmp[(grep(pattern='max x y z', tmp))]
  
  xmin <- as.numeric(unlist(strsplit(mins, " * "))[6])
  xmax <- as.numeric(unlist(strsplit(maxs, " * "))[6])
  ymin <- as.numeric(unlist(strsplit(mins, " * "))[7])
  ymax <- as.numeric(unlist(strsplit(maxs, " * "))[7])
  
  wkt_astext=paste("POLYGON((",xmin," ",ymin,",",xmin," ",ymax,",", xmax," ",ymax,",",
                   xmax," ", ymin,",",xmin," ",ymin,"))",sep="")
  
  gpsrange <- tmp[(grep(pattern = "  gps_time", tmp))]
  gpsrange2=unlist(strsplit(gpsrange, split=" "))
  MinGpstime=as.character(as.POSIXct(as.numeric(gpsrange2[4])+1000000000,origin="1980-01-06"))
  MaxGpstime=as.character(as.POSIXct(as.numeric(gpsrange2[5])+1000000000,origin="1980-01-06"))
  
  Year=substring(MaxGpstime,1,4)
  Month=substring(MaxGpstime,6,7)
  Day=substring(MaxGpstime,9,10)
  
  zmin=as.numeric(unlist(strsplit(mins, " * "))[8])
  zmax=as.numeric(unlist(strsplit(maxs, " * "))[8])
  
  RetNum_str <- tmp[(grep(pattern = "  return_number", tmp))]
  maxRetNum<-as.numeric(unlist(strsplit(RetNum_str, split=" "))[20])
  
  NumofRet_str <- tmp[(grep(pattern = "  number_of_returns", tmp))]
  maxNumofRet<-as.numeric(unlist(strsplit(NumofRet_str, split=" "))[16])
  
  Class_str <- tmp[(grep(pattern = "  classification", tmp))]
  minClass <-as.numeric(unlist(strsplit(Class_str, split=" "))[9])
  maxClass <-as.numeric(unlist(strsplit(Class_str, split=" "))[18])
  
  ScanAngle_str <- tmp[(grep(pattern = "  scan_angle_rank", tmp))]
  minScanAngle <-as.numeric(unlist(strsplit(ScanAngle_str, split=" "))[6])
  maxScanAngle <-as.numeric(unlist(strsplit(ScanAngle_str, split=" "))[15])
  
  FirstRet_str <- tmp[(grep(pattern = "number of first returns:", tmp))]
  FirstRet <-as.numeric(unlist(strsplit(FirstRet_str, split=" "))[12])
  
  InterRet_str <- tmp[(grep(pattern = "number of intermediate returns:", tmp))]
  InterRet <-as.numeric(unlist(strsplit(InterRet_str, split=" "))[5])
  
  LastRet_str <- tmp[(grep(pattern = "number of last returns:", tmp))]
  LastRet <-as.numeric(unlist(strsplit(LastRet_str, split=" "))[13])
  
  SingleRet_str <- tmp[(grep(pattern = "number of single returns:", tmp))]
  SingleRet <-as.numeric(unlist(strsplit(SingleRet_str, split=" "))[11])
  
  PointDens_str <- tmp[(grep(pattern = "point density:", tmp))]
  allPointDens <-as.numeric(unlist(strsplit(PointDens_str, split=" "))[5])
  lastonlyPointDens <-as.numeric(unlist(strsplit(PointDens_str, split=" "))[8])
  
  NofFile_str <- tmp[(grep(pattern = "  point_source_ID", tmp))]
  minFileID <-as.numeric(unlist(strsplit(NofFile_str, split=" "))[4])
  maxFileID <-as.numeric(unlist(strsplit(NofFile_str, split=" "))[10])
  
  epgs=epsg(lidrmeta)
  wkt=wkt(lidrmeta)
  
  crs=case_when(epgs==0 & wkt=="" ~ "No georef info",epgs>0 ~ "It has epgs info",wkt!="" ~ "It has wkt info")
  
  if (NumPoints>0) {
    
    newline <- cbind(BlockID,FileName,wkt_astext,NumPoints,MinGpstime,MaxGpstime,Year,Month,Day,zmin,zmax,maxRetNum,maxNumofRet,minClass,maxClass,
                     minScanAngle,maxScanAngle,FirstRet,InterRet,LastRet,SingleRet,allPointDens,lastonlyPointDens,minFileID,maxFileID,epgs,crs)
    
  } 
  
  newline
  
}

stopCluster(cl)

# export

st=format(Sys.time(), "%Y%m%d_%H%M")

filelist_df=as.data.frame(filelist)
names(filelist_df) <- "FileName"

lasinfo_df=as.data.frame(lasinfo)
lasinfo_df[, c(4,10:13,16:25)] <- sapply(lasinfo_df[, c(4,10:13,16:25)], as.numeric)
colnames(lasinfo_df) <- x

processed=as.data.frame(lasinfo_df$FileName)
names(processed) <- "FileName"

filechecked=merge(x = filelist_df, y = lasinfo_df, by = "FileName",all.x=TRUE,all.y=FALSE)
write.csv(filechecked,paste(outputdirectory,dirname,"_",st,".csv",sep=""))

lasinfo_df_c=lasinfo_df[!is.na(lasinfo_df$wkt_astext),]
df = st_as_sf(lasinfo_df_c, wkt = "wkt_astext")
st_crs(df) <- 25832
st_write(df, paste(outputdirectory,dirname,"_",st,".shp",sep=""))

# give info about potentially corrupt files

filecheck=setdiff(filelist_df,processed)
write.csv(filecheck,paste(outputdirectory,dirname,"_problematic_files_",st,".csv",sep=""))

# visualization #reused from Jakob repository https://github.com/jakobjassmann/ecodes-dk-lidar/blob/8a3b659d6ae45a5a4ce4250aaf812b13383db877/documentation/generate_date_stamp_figure.R

df = st_read("O:/Nat_Ecoinformatics-tmp/au700510/lidar_process/metainfo_extract/GST_2014_20211015_0148w_crs.shp")
names(df)[4] <- "MinGpstime"
names(df)[5] <- "MaxGpstime"
names(df)[21] <- "allPointDens"

df$year_month <- paste(substring(df$MaxGpstime,1,4)," ",substring(df$MaxGpstime,6,7),sep="")
df$year_month [df$year_month  == "2011 09"] <- NA
df$year_month <- as.factor(df$year_month)

recent_plot <-ggplot() +
  geom_sf(data = df,
          aes(fill = year_month),
          colour = NA) +
  labs(fill = "Year, Month", title = "Tile acquisition dates", 
       subtitle = "Most recent GPS timestamp per tile") +
  scale_fill_manual(values = c("#C86DD7",
                               rep("#00AD9A",3),
                               rep("#50A315",3),
                               rep("#009ADE",3),
                               rep("#B88A00",3),
                               "#E16A86")) +
  theme_cowplot()
save_plot(paste(outputdirectory,dirname,"_recent_gpstime",".png",sep=""), recent_plot,
          base_height = 6)

df$year_month2 <- paste(substring(df$MinGpstime,1,4)," ",substring(df$MinGpstime,6,7),sep="")
df$year_month2 [df$year_month2  == "2011 09"] <- NA
df$year_month2 <- as.factor(df$year_month)

oldest_plot <-ggplot() +
  geom_sf(data = df,
          aes(fill = year_month2),
          colour = NA) +
  labs(fill = "Year, Month", title = "Tile acquisition dates", 
       subtitle = "Oldest GPS timestamp per tile") +
  scale_fill_manual(values = c("#C86DD7",
                               rep("#00AD9A",3),
                               rep("#50A315",3),
                               rep("#009ADE",3),
                               rep("#B88A00",3),
                               "#E16A86")) +
  theme_cowplot()
save_plot(paste(outputdirectory,dirname,"_oldest_gpstime",".png",sep=""), recent_plot,
          base_height = 6)

pdens_plot <-ggplot() +
  geom_sf(data = df, aes(fill = allPointDens),colour = NA)+
  scale_fill_gradient2(low = "blue", mid = "yellow", high = "red",limits=c(0, 30))+
  labs(fill = "Point density (all)", title = "Point density per tiles")+theme_cowplot()

save_plot(paste(outputdirectory,dirname,"_pdens",".png",sep=""), recent_plot,
          base_height = 6)

end_time <- Sys.time()
print(end_time - start_time)